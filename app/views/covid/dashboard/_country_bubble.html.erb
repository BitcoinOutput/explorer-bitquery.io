<div class="row">
  <div class="col-lg-12 mb-4">
    <div class="card">
      <div class="card-header">Correlation of Recovery and Death Rates </div>
      <div class="card-body">
        <br><strong style="color: red; ">Note that not all countries report recovered cases.</strong><br>
        <div id="bubbles"><%= t('loading') %></div>
      </div>
    </div>
  </div>
</div>


<script>

    var bubbles_query = new widgets.query(`
    query($from: ISO8601DateTime, $till: ISO8601DateTime) {
      offchain {
       covid {
          facts(date: {since: $from, till: $till} ){

        country {
          name
          continent
        }

        confirmed
        recovered
        deaths
       }
      }
     }

    }`);

    widgets.callbacks({
        renderRecovered: function(item){
            return 100.0 * item.recovered / item.confirmed;
        },
        renderDeaths: function(item){
            return 100.0 * item.deaths / item.confirmed;
        },
    });

    new widgets.chart('#bubbles', bubbles_query, 'offchain.covid.facts', {

        chartType: 'BubbleChart',
        chartOptions: {
            hAxis: {title: 'Recovered / Confirmed, %'},
            height: 800,
            vAxes: {
                '0': {
                    title: 'Death / Confirmed, %'
                }
            },
            sizeAxis: {minValue: 0,  maxSize: 200}
        },
        dataOptions: [
            {
                title: 'Country',
                path: 'country.name'
            },
            {
                title: 'Recovered / Confirmed, %',
                renderCallbackName: 'renderRecovered'
            },
            {
                title: 'Death / Confirmed, %',
                renderCallbackName: 'renderDeaths'
            },
            {
                title: 'Continent',
                path: 'country.continent'
            },
            {
                title: 'Confirmed Cases',
                path: 'confirmed'
            }
        ]
    });

    bubbles_query.request({from: <%= @from.html_safe %>, till: <%= @till.html_safe %>});

    rr.change(function(start, end, clear){
        bubbles_query.request({from: start, till: end});
    })

</script>