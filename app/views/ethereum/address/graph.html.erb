<%= @info.inspect %>
<div class="row">
  <div class="col-12 col-lg-12 mb-4">
    <div class="card">
      <div class="card-header"><%= t('widgets.headers.graph') %></div>
      <div class="card-body">
        <div id="graph"><%= t('loading') %></div>
      </div>
    </div>
  </div>
</div>

<script>

    $( document ).ready(function() {


        var query = new widgets.query(`
                        query ($network: EthereumNetwork!,
                                $address: String!,
                                $limit: Int!,
                                $from: ISO8601DateTime,
                                $till: ISO8601DateTime){
                        ethereum(network: $network){

                          inbound: transfers(options:{desc: "amount", limit: $limit},
                            date: {since: $from till: $till },

                            currency:{is:"ETH"}
                            receiver:{is: $address}

                          ) {

                            sender {
                              address
                              annotation
                              smartContract {
                                contractType
                                currency {
                                  symbol
                                }
                              }
                            }
                            receiver {
                              address
                              annotation
                              smartContract {
                                contractType
                                currency {
                                  symbol
                                }
                              }
                            }

                            amount
                            transfers: count
                            txs: count(uniq: txs)

                          }


                          outbound: transfers(options:{desc: "amount", limit: $limit},
                            date: {since: $from till: $till },

                            currency:{is:"ETH"}
                            sender:{is: $address}

                          ) {

                            sender {
                              address
                              annotation
                              smartContract {
                                contractType
                                currency {
                                  symbol
                                }
                              }
                            }
                            receiver {
                              address
                              annotation
                              smartContract {
                                contractType
                                currency {
                                  symbol
                                }
                              }
                            }

                            amount
                            transfers: count
                            txs: count(uniq: txs)
                          }


                        }
                      }`);

        new widgets.template('#graph', query, '', {
            test_array: [1,2,3,4],
            test_obj: {a:1, b:2, c: {d: 3}},
            title: '<%= t('widgets.headers.graph') %>',
            callback: function(domNode, data){
                let _ = widgets.lodash;

                this.prepareNodes = function(nodes){
                    let prepareNode = function(node){
                        if (node.address == '0x0000000000000000000000000000000000000000'){
                            return {
                                id: node.address,
                                label: 'System',
                                group: 'system',
                                title: node.address
                            };
                        } else if(node.smartContract.contractType == 'Generic'){
                            return {
                                id: node.address,
                                label: _.truncate(node.address, {length: 15, separator: '...'}),
                                group: 'smart_contract',
                                title: 'Smart Contract ' + node.address
                            };
                        } else if(node.smartContract.contractType == 'Token' || node.smartContract.contractType == 'TokenSale'){
                            return {
                                id: node.address,
                                label: node.annotation +' ('+node.smartContract.currency.symbol+')',
                                group: 'token',
                                title: node.annotation +' ('+node.smartContract.currency.symbol+')' + ' ' + node.address
                            };
                        } else if(node.smartContract.contractType == 'MarginPositionToken'){
                            return {
                                id: node.address,
                                label: node.annotation || _.truncate(node.address, {length: 15, separator: '...'}),
                                group: 'MarginPositionToken',
                                title: 'MarginPositionToken ' + node.address
                            };
                        } else if(node.smartContract.contractType == 'Multisig'){
                            return {
                                id: node.address,
                                label: node.annotation || _.truncate(node.address, {length: 15, separator: '...'}),
                                group: 'multisig',
                                title: 'MultiSig Wallet ' + node.address
                            };
                        } else if(node.smartContract.contractType == 'DEX'){
                            return {
                                id: node.address,
                                label: node.annotation || _.truncate(node.address, {length: 15, separator: '...'}),
                                group: 'dex',
                                title: 'DEX ' + node.address
                            };
                        } else {
                            return {
                                id: node.address,
                                label: node.annotation || _.truncate(node.address, {length: 15, separator: '...'}),
                                group: node.annotation ? 'annotated_address' : 'address',
                                title: node.address
                            };
                        }
                    };

                    let prepared = [];
                    _.each(nodes, function(node){
                            prepared.push(prepareNode(node.receiver));
                            prepared.push(prepareNode(node.sender));
                    });
                    return prepared;
                };

                this.prepareEdges = function(edges, receiver = true, address = '<%= @address %>'){
                    let g = this;
                    let prepareEdge = function(edge){
                        let currency_name = 'ETH';//edge.currency.symbol;
                        let width_counts = Math.log(edge.transfers)+1;
                        let width = (edge.amount > 1) ? 1.5*Math.log10(edge.amount)+1 : 1;
                        let value = parseFloat(edge.amount)<=1e-6 ? edge.amount : numeral(edge.amount).format('0.0000a');

                        let label = value + ' ' + currency_name;

                        if(receiver){
                            return {
                                from: edge.sender.address,
                                to: address,
                                arrows: 'to',
                                label: label,
                                color: {color: 'grey', highlight: '#ff5722'},
                                font: {align: 'middle', multi: true},
                                smooth: true,
                                width: width,
                                select_type: 'select_transfers',
                                hidden: false,
                                id: g.hashCode(['select_transfers', edge.sender.address, address, label])
                            }
                        } else {
                            return {
                                from: address,
                                to: edge.receiver.address,
                                arrows: 'to',
                                label: label,
                                color: {color: 'black', highlight: '#ff5722'},
                                font: {align: 'middle', multi: true},
                                smooth: true,
                                width: width,
                                select_type: 'select_transfers',
                                hidden: false,
                                id: g.hashCode(['select_transfers', address, edge.receiver.address, label])
                            }
                        }
                    };
                    let prepared = [];
                    _.each(edges, function(edge){
                        prepared.push(prepareEdge(edge));
                    });
                    return prepared;
                };

                this.hashCode = function(data){
                    var string = JSON.stringify(data);
                    if (Array.prototype.reduce){
                        return string.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
                    }
                    var hash = 0;
                    if (string.length === 0) return hash;
                    for (var i = 0; i < string.length; i++) {
                        var character  = string.charCodeAt(i);
                        hash  = ((hash<<5)-hash)+character;
                        hash = hash & hash; // Convert to 32bit integer
                    }
                    return hash;
                };

                this.dataset = {
                    nodes: new vis.DataSet(_.uniqBy(this.prepareNodes(data.ethereum.inbound).concat(this.prepareNodes(data.ethereum.outbound)), 'id')),
                    edges: new vis.DataSet(this.prepareEdges(data.ethereum.inbound).concat(this.prepareEdges(data.ethereum.outbound, false)))
                };

                this.options = {
                    height: '400px',
                    physics: {
                        stabilization: {
                            enabled: false,
                            iterations: 10,
                            onlyDynamicEdges: true
                        },
                        barnesHut: {
                            damping: 0.4,
                            avoidOverlap: 0.1,
                            springConstant: 0.09
                        }
                    },
                    groups: {
                        smart_contract: {
                            shape: 'icon',
                            icon: {
                                face: 'FontAwesome',
                                code: '\uf013',
                                weight: 900,
                                size: 40,
                                color: '#f0a30a'
                            }
                        },
                        multisig: {
                            shape: 'icon',
                            icon: {
                                face: 'FontAwesome',
                                code: '\uf4d3',
                                weight: 900,
                                size: 40,
                                color: '#03a9f4'
                            }
                        },
                        address: {
                            shape: 'icon',
                            icon: {
                                face: 'FontAwesome',
                                code: '\uf007',
                                weight: 900,
                                size: 40,
                                color: '#009688'
                            }
                        },
                        annotated_address: {
                            shape: 'icon',
                            icon: {
                                face: 'FontAwesome',
                                code: '\uf007',
                                weight: 900,
                                size: 40,
                                color: '#006650',
                            },
                            font: {
                                background: '#006650',
                                color: 'white'
                            }
                        },
                        token: {
                            shape: 'icon',
                            icon: {
                                face: 'FontAwesome',
                                code: '\uf51f',
                                weight: 900,
                                size: 40,
                                color: '#ff5722'
                            }
                        },
                        dex: {
                            shape: 'icon',
                            icon: {
                                face: 'FontAwesome',
                                code: '\uf021',
                                weight: 900,
                                size: 40,
                                color: '#03a9f4'
                            }
                        },
                        MarginPositionToken: {
                            shape: 'icon',
                            icon: {
                                face: 'FontAwesome',
                                code: '\uf1b2',
                                weight: 900,
                                size: 40,
                                color: '#ff5722'
                            }
                        },
                        system: {
                            shape: 'icon',
                            icon: {
                                face: 'FontAwesome',
                                code: '\uf0ac',
                                weight: 900,
                                size: 40,
                                color: '#009688'
                            }
                        }
                    }
                };

                this.draw = function(){
                    let g = this;
                    let network = new vis.Network(domNode, this.dataset, this.options);

                    network.on('dragEnd', function (t) {
                        _.each(t.nodes, function(node, i){
                            g.dataset.nodes.update({id: node, physics: false});
                        });
                    });

                    network.on('doubleClick', function(target){
                        if(target.nodes.length>0){
                            var node_id = target.nodes[0];
                            if(g.dataset.nodes.get(node_id).group!='system'){
                                g.expand(node_id);
                            }

                        }
                    });

                };

                this.expand = function(address){
                    let g = this;
                    if(!g.dataset.nodes.get(address).expanded){
                        g.dataset.nodes.update({id: address, physics: false, expanded: true});
                        query.request({
                            network: '<%= params['network']['network'] %>',
                            address: address
                        }, function(result){
                            _.each(_.uniqBy(g.prepareNodes(result.ethereum.inbound).concat(g.prepareNodes(result.ethereum.outbound)), 'id'), function(node){
                                if(!g.dataset.nodes.get(node.id)){
                                    g.dataset.nodes.add(node);
                                }
                            });
                            _.each(g.prepareEdges(result.ethereum.inbound, true, address).concat(g.prepareEdges(result.ethereum.outbound, false, address)), function(edge){
                                if(!g.dataset.edges.get(edge.id)){
                                    g.dataset.edges.add(edge);
                                }
                            });

                        });
                    }
                };

                this.draw();
            }
        });

        queryWithTimeRange(rr, query, <%= @from.html_safe %>,<%= @till.html_safe %>,{
            network: '<%= params['network']['network'] %>',
            address: '<%= @address %>'
        });
//        query.request({
  //          network: '<%#= params['network']['network'] %>',
    //        address: '<%#= @address %>'
      //  }, undefined, fal)se
    });

</script>